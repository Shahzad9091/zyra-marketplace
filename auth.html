<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zyra | Onboarding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="card mx-auto shadow-sm p-4" style="max-width: 450px; border-radius: 15px;">
        <h2 class="text-center fw-bold text-primary">ZYRA</h2>
        <div id="setup-check" class="alert alert-warning small">Checking Configuration...</div>

        <div id="step1">
            <label class="form-label fw-bold">1. Email & Password</label>
            <input type="email" id="email" class="form-control mb-2" placeholder="Email">
            <input type="password" id="pass" class="form-control mb-3" placeholder="Password (Min 6 chars)">
            <button onclick="sendOTP()" class="btn btn-primary w-100">Send OTP</button>
        </div>

        <div id="step2" class="d-none">
            <label class="form-label fw-bold">2. Enter OTP</label>
            <input type="text" id="otpInput" class="form-control mb-3" placeholder="6-Digit Code">
            <button onclick="verifyOTP()" class="btn btn-success w-100">Verify Code</button>
        </div>

        <div id="step3" class="d-none">
            <label class="form-label fw-bold">3. Identity (Pakistan Only)</label>
            <input type="text" id="kName" class="form-control mb-2" placeholder="Full Name (As per CNIC)">
            <input type="text" id="kCnic" class="form-control mb-2" maxlength="13" placeholder="13-Digit CNIC">
            <select id="kCity" class="form-select mb-3">
                <option value="Karachi">Karachi</option>
                <option value="Lahore">Lahore</option>
                <option value="Islamabad">Islamabad</option>
            </select>
            <button onclick="completeKYC()" class="btn btn-dark w-100">Complete Registration</button>
        </div>
    </div>
</div>

<script>
    // --- UPDATE THESE IMMEDIATELY ---
    const firebaseConfig = {
        apiKey: "AIzaSyChffCcsk7nhnGiui0LoL63qWdrHWrktRc",
  authDomain: "zyra-v2.firebaseapp.com",
  projectId: "zyra-v2",
  storageBucket: "zyra-v2.firebasestorage.app",
  messagingSenderId: "627745459140",
  appId: "1:627745459140:web:94d952414d5caa2277f291",
  measurementId: "G-JRJ8N3LVXE"
    };

    const EMAILJS_KEY = "lBG0APIGvXqSbU_ao";
    const SERVICE_ID = "service_gg7fkqa";
    const TEMPLATE_ID = "template_x71xmoe";
    // --------------------------------

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    emailjs.init(EMAILJS_KEY);

    // Config Check
    if(firebaseConfig.apiKey !== "AIzaSyChffCcsk7nhnGiui0LoL63qWdrHWrktRc") {
        document.getElementById('setup-check').className = "alert alert-success small";
        document.getElementById('setup-check').innerText = "System Ready for Onboarding";
    }

    let generatedOTP;
    let savedEmail, savedPass;

    async function sendOTP() {
        savedEmail = document.getElementById('email').value;
        savedPass = document.getElementById('pass').value;
        generatedOTP = Math.floor(100000 + Math.random() * 900000);
        
        try {
            await emailjs.send(SERVICE_ID, TEMPLATE_ID, { to_email: savedEmail, otp: generatedOTP });
            alert("OTP Sent!");
            document.getElementById('step1').classList.add('d-none');
            document.getElementById('step2').classList.remove('d-none');
        } catch(e) { alert("EmailJS Config Error"); }
    }

    function verifyOTP() {
        if(document.getElementById('otpInput').value == generatedOTP) {
            document.getElementById('step2').classList.add('d-none');
            document.getElementById('step3').classList.remove('d-none');
        } else { alert("Invalid OTP"); }
    }

    async function completeKYC() {
        const name = document.getElementById('kName').value;
        const cnic = document.getElementById('kCnic').value;
        const city = document.getElementById('kCity').value;

        try {
            const nadraDoc = await db.collection("nadra_records").doc(cnic).get();
            if(nadraDoc.exists && nadraDoc.data().name.toLowerCase() === name.toLowerCase()) {
                const cred = await auth.createUserWithEmailAndPassword(savedEmail, savedPass);
                await db.collection("users").doc(cred.user.uid).set({
                    email: savedEmail, cnic: cnic, city: city, isVerified: true, reputation: 100
                });
                alert("Verified! Next week submission ready.");
                window.location.href = "dashboard.html";
            } else { alert("KYC Failed: Name/CNIC mismatch."); }
        } catch(e) { alert(e.message); }
    }
</script>
</body>
</html>